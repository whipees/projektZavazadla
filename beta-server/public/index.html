<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BagTrace Dashboard</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <h1>BagTrace</h1>

    <div class="plane-container">
        <h3 style="width: 100%; margin-top: 0;">Letadla a jejich kufry</h3>
        <div id="plane-list"></div>
    </div>
    
    <div class="belts-wrapper">
        <div id="belt-1" class="belt">
            <h2>Pás č. 1 (Czech)</h2>
            <div id="list-1"></div>
        </div>
        <div id="belt-2" class="belt">
            <h2>Pás č. 2 (International)</h2>
            <div id="list-2"></div>
        </div>
    </div>

    <script>
        const ws = new WebSocket(`ws://${location.host}`);
        const activeTimers = {};    

        // NASTAVENÍ ČASOVAČE
        const TIMEOUT_MS = 20000; 

        ws.onopen = () => console.log("Připojeno k Beta");

        ws.onmessage = (event) => {
            const msg = JSON.parse(event.data);
            console.log("Nová zpráva:", msg);
            
            if (msg.type === 'PLANE_LOADED') {
                createBagInPlane(msg.bag);
            } else if (msg.type === 'BELT_ARRIVAL') {
                moveBagToBelt(msg.bag, msg.belt);
            }
        };
        function getBagHTML(bag) {
            return `
                 <b>${bag.owner}</b><br>
                <small>Let: ${bag.flight}</small>
                <span class="timer">Čeká na vyzvednutí...</span>
                <button onclick="pickupBag('${bag.id}')">Vyzvednout</button>
            `;
        }

        // Vytvoří kufr 
       function createBagInPlane(bag) {
            if (document.getElementById(`bag-${bag.id}`)) return;

            const el = document.createElement('div');
            el.id = `bag-${bag.id}`;
            el.className = 'bag in-plane';
            el.innerHTML = ` ${bag.flight}<br><small>${bag.owner}</small>`;
            
            document.getElementById('plane-list').appendChild(el);
        }

       function moveBagToBelt(bag, beltNum) {
            let el = document.getElementById(`bag-${bag.id}`);
            
            if (!el) {
                el = document.createElement('div');
                el.id = `bag-${bag.id}`;
            }

            el.className = 'bag'; 
            
            el.innerHTML = getBagHTML(bag);

            const beltList = document.getElementById(`list-${beltNum}`);
            beltList.prepend(el);

            activeTimers[bag.id] = setTimeout(() => {
                el.classList.add('missed');
                el.querySelector('.timer').innerText = " NEVYZVEDNUTO";
                const btn = el.querySelector('button');
                if(btn) btn.remove();
                
                delete activeTimers[bag.id];
            }, TIMEOUT_MS);
        }

        // Vyzvednout
       window.pickupBag = (id) => {
            const el = document.getElementById(`bag-${id}`);
            if (!el) return;

            if (activeTimers[id]) {
                clearTimeout(activeTimers[id]);
                delete activeTimers[id];
            }

            el.classList.add('ok');
            el.querySelector('.timer').innerText = "Vyzvednuto";
            
            const btn = el.querySelector('button');
            if(btn) btn.remove(); 

            fetch('http://localhost:3000/bag/collected', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ bagId: id })
            }).catch(err => console.log("Chyba při odesílání potvrzení na server"));
        };
    </script>
</body>
</html>